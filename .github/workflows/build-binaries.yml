# Build binaries for all modules and upload them as artifacts
# This workflow builds binaries for all modules and uploads them as artifacts

name: Build Binaries

on:
  workflow_dispatch:  # Manual trigger only
  push:
    tags:
      - 'v*'  # Auto trigger on version tags for release

env:
  GO_VERSION: '1.21'
  GOMODULE: github.com/OpenNHP/opennhp/nhp

jobs:
  # Generate version info in a separate job to ensure all platforms use the same version
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit_id: ${{ steps.version.outputs.commit_id }}
      commit_time: ${{ steps.version.outputs.commit_time }}
      build_time: ${{ steps.version.outputs.build_time }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        run: |
          VERSION=$(cat nhp/version/VERSION)
          TIMESTAMP=$(date +%y%m%d%H%M%S)
          FULL_VERSION="${VERSION}.${TIMESTAMP}"
          COMMIT_ID=$(git show -s --format=%H)
          COMMIT_TIME=$(git show -s --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          BUILD_TIME=$(date "+%Y-%m-%d %H:%M:%S")
          
          echo "version=${FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "commit_id=${COMMIT_ID}" >> $GITHUB_OUTPUT
          echo "commit_time=${COMMIT_TIME}" >> $GITHUB_OUTPUT
          echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT
          
          echo "Version: ${FULL_VERSION}"
          echo "Commit ID: ${COMMIT_ID}"
          echo "Commit Time: ${COMMIT_TIME}"
          echo "Build Time: ${BUILD_TIME}"

  build:
    needs: prepare
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            ext: ""
            archive_ext: tar.gz
          - os: windows-latest
            goos: windows
            goarch: amd64
            ext: ".exe"
            archive_ext: zip
          - os: macos-latest
            goos: darwin
            goarch: amd64
            ext: ""
            archive_ext: tar.gz

    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Set LD_FLAGS
        id: ldflags
        shell: bash
        run: |
          LD_FLAGS="-s -w -X '${GOMODULE}/version.Version=${{ needs.prepare.outputs.version }}' -X '${GOMODULE}/version.CommitId=${{ needs.prepare.outputs.commit_id }}' -X '${GOMODULE}/version.CommitTime=${{ needs.prepare.outputs.commit_time }}' -X '${GOMODULE}/version.BuildTime=${{ needs.prepare.outputs.build_time }}'"
          echo "ldflags=${LD_FLAGS}" >> $GITHUB_OUTPUT

      - name: Go mod tidy
        run: |
          cd nhp && go mod tidy
          cd ../endpoints && go mod tidy

      - name: Create output directories
        shell: bash
        run: |
          mkdir -p output/nhp-agent/etc
          mkdir -p output/nhp-ac/etc
          mkdir -p output/nhp-server/etc
          mkdir -p output/nhp-db/etc
          mkdir -p output/nhp-kgc/etc

      - name: Build nhp-agent
        shell: bash
        run: |
          cd endpoints
          go build -trimpath -ldflags "${{ steps.ldflags.outputs.ldflags }}" -v -o ../output/nhp-agent/nhp-agentd${{ matrix.ext }} ./agent/main/main.go
          cp ./agent/main/etc/*.toml ../output/nhp-agent/etc/
          cp -rf ./agent/main/etc/certs ../output/nhp-agent/etc/ 2>/dev/null || true

      - name: Build nhp-ac
        shell: bash
        run: |
          cd endpoints
          go build -trimpath -ldflags "${{ steps.ldflags.outputs.ldflags }}" -v -o ../output/nhp-ac/nhp-acd${{ matrix.ext }} ./ac/main/main.go
          cp ./ac/main/etc/*.toml ../output/nhp-ac/etc/

      - name: Build nhp-server
        shell: bash
        run: |
          cd endpoints
          go build -trimpath -ldflags "${{ steps.ldflags.outputs.ldflags }}" -v -o ../output/nhp-server/nhp-serverd${{ matrix.ext }} ./server/main/main.go
          cp ./server/main/etc/*.toml ../output/nhp-server/etc/

      - name: Build nhp-db
        shell: bash
        run: |
          cd endpoints
          go build -trimpath -ldflags "${{ steps.ldflags.outputs.ldflags }}" -v -o ../output/nhp-db/nhp-db${{ matrix.ext }} ./db/main/main.go
          cp ./db/main/etc/*.toml ../output/nhp-db/etc/

      - name: Build nhp-kgc
        shell: bash
        run: |
          cd endpoints
          go build -trimpath -ldflags "${{ steps.ldflags.outputs.ldflags }}" -v -o ../output/nhp-kgc/nhp-kgc${{ matrix.ext }} ./kgc/main/main.go
          cp ./kgc/main/etc/*.toml ../output/nhp-kgc/etc/

      # Upload each module as separate artifact
      - name: Upload nhp-agent artifact
        uses: actions/upload-artifact@v4
        with:
          name: nhp-agent-${{ matrix.goos }}-${{ matrix.goarch }}
          path: output/nhp-agent/
          retention-days: 30

      - name: Upload nhp-ac artifact
        uses: actions/upload-artifact@v4
        with:
          name: nhp-ac-${{ matrix.goos }}-${{ matrix.goarch }}
          path: output/nhp-ac/
          retention-days: 30

      - name: Upload nhp-server artifact
        uses: actions/upload-artifact@v4
        with:
          name: nhp-server-${{ matrix.goos }}-${{ matrix.goarch }}
          path: output/nhp-server/
          retention-days: 30

      - name: Upload nhp-db artifact
        uses: actions/upload-artifact@v4
        with:
          name: nhp-db-${{ matrix.goos }}-${{ matrix.goarch }}
          path: output/nhp-db/
          retention-days: 30

      - name: Upload nhp-kgc artifact
        uses: actions/upload-artifact@v4
        with:
          name: nhp-kgc-${{ matrix.goos }}-${{ matrix.goarch }}
          path: output/nhp-kgc/
          retention-days: 30

      # Create full package archive
      - name: Create archive (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          cd output
          tar -czvf opennhp-${{ needs.prepare.outputs.version }}-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz nhp-agent nhp-ac nhp-db nhp-server nhp-kgc

      - name: Create archive (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          cd output
          Compress-Archive -Path nhp-agent, nhp-ac, nhp-db, nhp-server, nhp-kgc -DestinationPath "opennhp-${{ needs.prepare.outputs.version }}-${{ matrix.goos }}-${{ matrix.goarch }}.zip"

      - name: Upload full package artifact
        uses: actions/upload-artifact@v4
        with:
          name: opennhp-${{ matrix.goos }}-${{ matrix.goarch }}
          path: output/opennhp-${{ needs.prepare.outputs.version }}-${{ matrix.goos }}-${{ matrix.goarch }}.${{ matrix.archive_ext }}
          retention-days: 30

  # Aggregate all platform artifacts
  summary:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: List artifacts
        run: |
          echo "=== All built artifacts ==="
          echo "Version: ${{ needs.prepare.outputs.version }}"
          find all-artifacts -type f -name "*.tar.gz" -o -name "*.zip" -o -name "nhp-*" | head -100
          echo ""
          echo "=== Artifact sizes ==="
          du -sh all-artifacts/*

      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: opennhp-all-platforms
          path: all-artifacts/opennhp-*/
          retention-days: 30

  # Update latest release (permanent storage for latest build)
  latest-release:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all package artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: opennhp-*
          path: release-artifacts
          merge-multiple: false

      - name: Prepare release files
        run: |
          mkdir -p release-files
          find release-artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release-files/ \;
          ls -la release-files/

      - name: Update latest release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest Build
          body: |
            ðŸš€ **Latest Build Artifacts**
            
            This release is automatically updated after each build with the latest binaries.
            
            **Version:** ${{ needs.prepare.outputs.version }}
            **Commit:** ${{ github.sha }}
            **Build Time:** ${{ needs.prepare.outputs.build_time }}
          files: release-files/*
          prerelease: true
          make_latest: false

  # Create official release when pushing version tags
  release:
    needs: [prepare, build]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all package artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: opennhp-*
          path: release-artifacts
          merge-multiple: false

      - name: Prepare release files
        run: |
          mkdir -p release-files
          find release-artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release-files/ \;
          ls -la release-files/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-files/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}

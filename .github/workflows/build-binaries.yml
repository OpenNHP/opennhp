# This workflow builds binaries for all modules and uploads them as artifacts

name: Build Binaries

on:
  push:
    branches: ["main", "develop"]
    tags:
      - 'v*'
  pull_request:
    branches: ["main"]
  workflow_dispatch:  # Manual trigger support

# Restrict default permissions for security (CodeQL alert fix)
permissions:
  contents: read

env:
  GO_VERSION: '1.25'
  GOMODULE: github.com/OpenNHP/opennhp/nhp

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            ext: ""
            archive_ext: tar.gz
          - os: windows-latest
            goos: windows
            goarch: amd64
            ext: ".exe"
            archive_ext: zip
          - os: macos-latest
            goos: darwin
            goarch: amd64
            ext: ""
            archive_ext: tar.gz

    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Get full history for commit info

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get version info
        id: version
        shell: bash
        run: |
          VERSION=$(cat nhp/version/VERSION)
          TIMESTAMP=$(date +%y%m%d%H%M%S)
          FULL_VERSION="${VERSION}.${TIMESTAMP}"
          COMMIT_ID=$(git show -s --format=%H)
          COMMIT_TIME=$(git show -s --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          BUILD_TIME=$(date "+%Y-%m-%d %H:%M:%S")
          
          echo "version=${FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "commit_id=${COMMIT_ID}" >> $GITHUB_OUTPUT
          echo "commit_time=${COMMIT_TIME}" >> $GITHUB_OUTPUT
          echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT
          
          echo "Version: ${FULL_VERSION}"
          echo "Commit ID: ${COMMIT_ID}"
          echo "Commit Time: ${COMMIT_TIME}"
          echo "Build Time: ${BUILD_TIME}"

      - name: Set LD_FLAGS
        id: ldflags
        shell: bash
        run: |
          LD_FLAGS="-s -w -X '${GOMODULE}/version.Version=${{ steps.version.outputs.version }}' -X '${GOMODULE}/version.CommitId=${{ steps.version.outputs.commit_id }}' -X '${GOMODULE}/version.CommitTime=${{ steps.version.outputs.commit_time }}' -X '${GOMODULE}/version.BuildTime=${{ steps.version.outputs.build_time }}'"
          echo "ldflags=${LD_FLAGS}" >> $GITHUB_OUTPUT

      - name: Clone external plugin repositories
        if: vars.EXTERNAL_PLUGIN_REPOS != ''
        shell: bash
        env:
          REPOS_JSON: ${{ vars.EXTERNAL_PLUGIN_REPOS }}
          PLUGIN_TOKEN: ${{ secrets.PLUGIN_REPO_TOKEN }}
        run: |
          # Parse JSON configuration for external repositories
          # Expected format: [{"url": "https://github.com/org/repo", "path": "endpoints/examples/server_plugin/plugin-name", "ref": "main"}]

          if [ -z "$REPOS_JSON" ]; then
            echo "‚ÑπÔ∏è  No external plugin repositories configured"
            exit 0
          fi

          echo "üì¶ Cloning external plugin repositories..."
          mkdir -p endpoints/examples/server_plugin

          # Use jq if available, otherwise use Python
          if command -v jq &> /dev/null; then
            echo "$REPOS_JSON" | jq -c '.[]' | while read -r repo; do
              url=$(echo "$repo" | jq -r '.url')
              path=$(echo "$repo" | jq -r '.path')
              ref=$(echo "$repo" | jq -r '.ref // "main"')

              if [ -z "$url" ] || [ -z "$path" ]; then
                echo "‚ö†Ô∏è  Skipping invalid repo config"
                continue
              fi

              # Add token to URL if available
              if [ -n "$PLUGIN_TOKEN" ] && [[ "$url" == https://github.com/* ]]; then
                url="${url/https:\/\/github.com\//https://x-access-token:${PLUGIN_TOKEN}@github.com/}"
              fi

              echo "üì• Cloning $url (ref: $ref) to $path"
              if git clone --depth 1 --branch "$ref" "$url" "$path"; then
                echo "‚úÖ Successfully cloned to $path"
              else
                echo "‚ùå Failed to clone $url"
                exit 1
              fi
            done
          else
            # Fallback to Python
            python3 << 'EOF'
          import json
          import os
          import sys
          import subprocess

          repos_json = os.environ.get('REPOS_JSON', '[]')
          token = os.environ.get('PLUGIN_TOKEN', '')

          try:
              repos = json.loads(repos_json)
          except json.JSONDecodeError as e:
              print(f"‚ùå Invalid JSON: {e}")
              sys.exit(1)

          for repo in repos:
              url = repo.get('url', '')
              path = repo.get('path', '')
              ref = repo.get('ref', 'main')

              if not url or not path:
                  continue

              # Add token for GitHub URLs
              if token and 'github.com' in url and url.startswith('https://'):
                  url = url.replace('https://github.com/', f'https://x-access-token:{token}@github.com/')

              print(f"üì• Cloning {repo.get('url')} (ref: {ref}) to {path}")

              result = subprocess.run(
                  ['git', 'clone', '--depth', '1', '--branch', ref, url, path],
                  capture_output=True, text=True
              )

              if result.returncode != 0:
                  print(f"‚ùå Failed: {result.stderr}")
                  sys.exit(1)

              print(f"‚úÖ Successfully cloned to {path}")
          EOF
          fi

          echo "‚úÖ All external plugin repositories cloned successfully"

      - name: Go mod tidy
        run: |
          cd nhp && go mod tidy
          cd ../endpoints && go mod tidy

      - name: Create output directories
        shell: bash
        run: |
          mkdir -p output/nhp-agent/etc
          mkdir -p output/nhp-ac/etc
          mkdir -p output/nhp-server/etc
          mkdir -p output/nhp-db/etc
          mkdir -p output/nhp-kgc/etc

      - name: Build nhp-agent
        shell: bash
        run: |
          cd endpoints
          go build -trimpath -ldflags "${{ steps.ldflags.outputs.ldflags }}" -v -o ../output/nhp-agent/nhp-agentd${{ matrix.ext }} ./agent/main/main.go
          cp ./agent/main/etc/*.toml ../output/nhp-agent/etc/
          cp -rf ./agent/main/etc/certs ../output/nhp-agent/etc/ 2>/dev/null || true

      - name: Build nhp-ac
        shell: bash
        run: |
          cd endpoints
          go build -trimpath -ldflags "${{ steps.ldflags.outputs.ldflags }}" -v -o ../output/nhp-ac/nhp-acd${{ matrix.ext }} ./ac/main/main.go
          cp ./ac/main/etc/*.toml ../output/nhp-ac/etc/

      - name: Build nhp-server
        shell: bash
        run: |
          cd endpoints
          go build -trimpath -ldflags "${{ steps.ldflags.outputs.ldflags }}" -v -o ../output/nhp-server/nhp-serverd${{ matrix.ext }} ./server/main/main.go
          cp ./server/main/etc/*.toml ../output/nhp-server/etc/
          # Copy templates directory if it exists
          if [ -d ../docker/nhp-server/templates ]; then
            cp -r ../docker/nhp-server/templates ../output/nhp-server/
            echo "‚úÖ Templates directory copied to output"
          fi

      - name: Build server plugins
        shell: bash
        run: |
          echo "üîå Building server plugins..."
          mkdir -p output/nhp-server/plugins

          # Build basic plugin
          if [ -d examples/server_plugin/basic ]; then
            echo "Building basic plugin..."
            cd examples/server_plugin/basic
            go mod tidy
            go build -buildmode=plugin -trimpath -ldflags "-s -w" -v -o ../../../output/nhp-server/plugins/example/example.so ./main.go
            mkdir -p ../../../output/nhp-server/plugins/example/etc
            cp ./etc/*.toml ../../../output/nhp-server/plugins/example/etc/
            mkdir -p ../../../output/nhp-server/templates/example
            cp ./templates/*.* ../../../output/nhp-server/templates/example/ 2>/dev/null || true
            cd ../../..
            echo "‚úÖ Basic plugin built"
          fi

          # Build authenticator plugin
          if [ -d examples/server_plugin/authenticator ]; then
            echo "Building authenticator plugin..."
            cd examples/server_plugin/authenticator
            go mod tidy
            go build -buildmode=plugin -trimpath -ldflags "-s -w" -v -o ../../../output/nhp-server/plugins/qrauth/qrauth.so ./main.go ./qrauth.go
            mkdir -p ../../../output/nhp-server/plugins/qrauth/etc
            cp ./etc/*.toml ../../../output/nhp-server/plugins/qrauth/etc/
            mkdir -p ../../../output/nhp-server/templates/qrauth
            cp ./templates/*.* ../../../output/nhp-server/templates/qrauth/ 2>/dev/null || true
            cd ../../..
            echo "‚úÖ Authenticator plugin built"
          fi

          echo "‚úÖ All plugins built successfully"

      - name: Build nhp-db
        shell: bash
        run: |
          cd endpoints
          go build -trimpath -ldflags "${{ steps.ldflags.outputs.ldflags }}" -v -o ../output/nhp-db/nhp-db${{ matrix.ext }} ./db/main/main.go
          cp ./db/main/etc/*.toml ../output/nhp-db/etc/

      - name: Build nhp-kgc
        shell: bash
        run: |
          cd endpoints
          go build -trimpath -ldflags "${{ steps.ldflags.outputs.ldflags }}" -v -o ../output/nhp-kgc/nhp-kgc${{ matrix.ext }} ./kgc/main/main.go
          cp ./kgc/main/etc/*.toml ../output/nhp-kgc/etc/

      # Upload each module as independent artifact
      - name: Upload nhp-agent artifact
        uses: actions/upload-artifact@v6
        with:
          name: nhp-agent-${{ matrix.goos }}-${{ matrix.goarch }}
          path: output/nhp-agent/
          retention-days: 30

      - name: Upload nhp-ac artifact
        uses: actions/upload-artifact@v6
        with:
          name: nhp-ac-${{ matrix.goos }}-${{ matrix.goarch }}
          path: output/nhp-ac/
          retention-days: 30

      - name: Upload nhp-server artifact
        uses: actions/upload-artifact@v6
        with:
          name: nhp-server-${{ matrix.goos }}-${{ matrix.goarch }}
          path: output/nhp-server/
          retention-days: 30

      - name: Upload nhp-db artifact
        uses: actions/upload-artifact@v6
        with:
          name: nhp-db-${{ matrix.goos }}-${{ matrix.goarch }}
          path: output/nhp-db/
          retention-days: 30

      - name: Upload nhp-kgc artifact
        uses: actions/upload-artifact@v6
        with:
          name: nhp-kgc-${{ matrix.goos }}-${{ matrix.goarch }}
          path: output/nhp-kgc/
          retention-days: 30

      # Create complete package artifact
      - name: Create archive (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          cd output
          tar -czvf opennhp-${{ steps.version.outputs.version }}-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz nhp-agent nhp-ac nhp-db nhp-server nhp-kgc

      - name: Create archive (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          cd output
          Compress-Archive -Path nhp-agent, nhp-ac, nhp-db, nhp-server, nhp-kgc -DestinationPath "opennhp-${{ steps.version.outputs.version }}-${{ matrix.goos }}-${{ matrix.goarch }}.zip"

      - name: Upload full package artifact
        uses: actions/upload-artifact@v6
        with:
          name: opennhp-${{ matrix.goos }}-${{ matrix.goarch }}
          path: output/opennhp-${{ steps.version.outputs.version }}-${{ matrix.goos }}-${{ matrix.goarch }}.${{ matrix.archive_ext }}
          retention-days: 30

  # Aggregate artifacts from all platforms
  summary:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: all-artifacts

      - name: List artifacts
        run: |
          echo "=== All built artifacts ==="
          find all-artifacts -type f -name "*.tar.gz" -o -name "*.zip" -o -name "nhp-*" | head -100
          echo ""
          echo "=== Artifact sizes ==="
          du -sh all-artifacts/*

      - name: Upload combined artifact
        uses: actions/upload-artifact@v6
        with:
          name: opennhp-all-platforms
          path: all-artifacts/opennhp-*/
          retention-days: 30

  # Update latest release (only on main branch, not PRs)
  latest-release:
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all package artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: opennhp-*
          path: release-artifacts
          merge-multiple: false

      - name: Prepare release files
        run: |
          mkdir -p release-files
          find release-artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release-files/ \;
          ls -la release-files/

      - name: Update latest release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Build
          body: |
            **Latest Build Artifacts**

            This release is automatically updated after each build with the latest binaries.

            Build Time: ${{ github.event.head_commit.timestamp }}
            Commit: ${{ github.sha }}
          files: release-files/*
          prerelease: true
          make_latest: false

  # Create official release when a tag is pushed
  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all package artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: opennhp-*
          path: release-artifacts
          merge-multiple: false

      - name: Prepare release files
        run: |
          mkdir -p release-files
          find release-artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release-files/ \;
          ls -la release-files/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-files/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}


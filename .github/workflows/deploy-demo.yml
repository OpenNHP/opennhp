# Deploy to Demo servers
# This workflow deploys templates and optionally binaries to demo NHP servers

name: Deploy Demo

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      confirm:
        description: 'Type "deploy" to confirm deployment'
        required: true
        default: ''
      rebuild:
        description: 'Rebuild binaries before deployment'
        required: true
        type: choice
        options:
          - 'no'
          - 'yes'
        default: 'no'
      deploy_binaries:
        description: 'Deploy binaries (nhp-serverd)'
        required: true
        type: choice
        options:
          - 'no'
          - 'yes'
        default: 'no'

env:
  DEPLOY_USER: ec2-user
  DEPLOY_PATH: /home/ec2-user/nhp-server
  TEMPLATES_SOURCE: docker/nhp-server/templates
  GO_VERSION: '1.25'
  GOMODULE: github.com/OpenNHP/opennhp/nhp

jobs:
  build-binaries:
    if: github.event.inputs.confirm == 'deploy' && github.event.inputs.rebuild == 'yes'
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get version info
        id: version
        run: |
          VERSION=$(cat nhp/version/VERSION)
          TIMESTAMP=$(date +%y%m%d%H%M%S)
          FULL_VERSION="${VERSION}.${TIMESTAMP}"
          COMMIT_ID=$(git show -s --format=%H)
          COMMIT_TIME=$(git show -s --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          BUILD_TIME=$(date "+%Y-%m-%d %H:%M:%S")

          echo "version=${FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "commit_id=${COMMIT_ID}" >> $GITHUB_OUTPUT
          echo "commit_time=${COMMIT_TIME}" >> $GITHUB_OUTPUT
          echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT

      - name: Set LD_FLAGS
        id: ldflags
        run: |
          LD_FLAGS="-s -w -X '${GOMODULE}/version.Version=${{ steps.version.outputs.version }}' -X '${GOMODULE}/version.CommitId=${{ steps.version.outputs.commit_id }}' -X '${GOMODULE}/version.CommitTime=${{ steps.version.outputs.commit_time }}' -X '${GOMODULE}/version.BuildTime=${{ steps.version.outputs.build_time }}'"
          echo "ldflags=${LD_FLAGS}" >> $GITHUB_OUTPUT

      - name: Clone external plugin repositories
        if: vars.EXTERNAL_PLUGIN_REPOS != ''
        env:
          REPOS_JSON: ${{ vars.EXTERNAL_PLUGIN_REPOS }}
          PLUGIN_TOKEN: ${{ secrets.PLUGIN_REPO_TOKEN }}
        run: |
          if [ -z "$REPOS_JSON" ]; then
            echo "‚ÑπÔ∏è  No external plugin repositories configured"
            exit 0
          fi

          echo "üì¶ Cloning external plugin repositories..."
          mkdir -p endpoints/examples/server_plugin

          python3 << 'EOF'
          import json
          import os
          import sys
          import subprocess

          repos_json = os.environ.get('REPOS_JSON', '[]')
          token = os.environ.get('PLUGIN_TOKEN', '')

          try:
              repos = json.loads(repos_json)
          except json.JSONDecodeError as e:
              print(f"‚ùå Invalid JSON: {e}")
              sys.exit(1)

          for repo in repos:
              url = repo.get('url', '')
              path = repo.get('path', '')
              ref = repo.get('ref', 'main')

              if not url or not path:
                  continue

              if token and 'github.com' in url and url.startswith('https://'):
                  url = url.replace('https://github.com/', f'https://x-access-token:{token}@github.com/')

              print(f"üì• Cloning {repo.get('url')} (ref: {ref}) to {path}")

              result = subprocess.run(
                  ['git', 'clone', '--depth', '1', '--branch', ref, url, path],
                  capture_output=True, text=True
              )

              if result.returncode != 0:
                  print(f"‚ùå Failed: {result.stderr}")
                  sys.exit(1)

              print(f"‚úÖ Successfully cloned to {path}")
          EOF

      - name: Go mod tidy
        run: |
          cd nhp && go mod tidy
          cd ../endpoints && go mod tidy

      - name: Build nhp-serverd
        run: |
          cd endpoints
          CGO_ENABLED=1 go build -trimpath -ldflags "${{ steps.ldflags.outputs.ldflags }}" -v -o nhp-serverd ./server/main/main.go
          chmod +x nhp-serverd
          echo "‚úÖ nhp-serverd built successfully"

      - name: Build server plugins
        run: |
          echo "üîå Building server plugins..."
          mkdir -p build/plugins

          # Build basic plugin
          if [ -d examples/server_plugin/basic ]; then
            echo "Building basic plugin..."
            cd examples/server_plugin/basic
            go mod tidy
            CGO_ENABLED=1 go build -buildmode=plugin -trimpath -ldflags "-s -w" -v -o ../../../build/plugins/example.so ./main.go
            cd ../../..
            echo "‚úÖ Basic plugin built"
          fi

          # Build authenticator plugin
          if [ -d examples/server_plugin/authenticator ]; then
            echo "Building authenticator plugin..."
            cd examples/server_plugin/authenticator
            go mod tidy
            CGO_ENABLED=1 go build -buildmode=plugin -trimpath -ldflags "-s -w" -v -o ../../../build/plugins/qrauth.so ./main.go ./qrauth.go
            cd ../../..
            echo "‚úÖ Authenticator plugin built"
          fi

          ls -la build/plugins/
          echo "‚úÖ All plugins built successfully"

      - name: Upload binary artifact
        uses: actions/upload-artifact@v6
        with:
          name: nhp-serverd-linux-amd64
          path: |
            endpoints/nhp-serverd
            build/plugins/*.so
          retention-days: 1

  deploy-to-servers:
    needs: [build-binaries]
    if: |
      always() &&
      github.event.inputs.confirm == 'deploy' &&
      (needs.build-binaries.result == 'success' || needs.build-binaries.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        server: ${{ fromJson(vars.DEMO_NHP_SERVERS) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Validate server hostname
        run: |
          SERVER="${{ matrix.server }}"

          # RFC 1123 hostname validation: alphanumeric, hyphens, dots
          # Max 253 chars total, max 63 chars per label
          if ! echo "$SERVER" | grep -qE '^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$'; then
            echo "‚ùå SECURITY ERROR: Invalid hostname format: $SERVER"
            echo "Hostnames must comply with RFC 1123"
            exit 1
          fi

          # Block shell metacharacters
          if echo "$SERVER" | grep -qE '[$`();&|<>{}\\]'; then
            echo "‚ùå SECURITY ERROR: Hostname contains shell metacharacters: $SERVER"
            exit 1
          fi

          # Length validation
          if [ ${#SERVER} -gt 253 ]; then
            echo "‚ùå SECURITY ERROR: Hostname exceeds 253 characters"
            exit 1
          fi

          echo "‚úÖ Hostname validation passed: $SERVER"

      - name: Setup SSH key and known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Write SSH private key
          echo "${{ secrets.DEMO_NHP_SERVER_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Setup known_hosts - MUST be pre-configured to prevent MITM attacks
          if [ -z "${{ secrets.DEMO_NHP_SERVER_HOST_KEYS }}" ]; then
            echo "‚ùå SECURITY ERROR: DEMO_NHP_SERVER_HOST_KEYS secret is not configured"
            echo "Host keys must be pre-configured to prevent MITM attacks"
            echo "Please configure the secret with known_hosts entries for all demo servers"
            exit 1
          fi

          echo "${{ secrets.DEMO_NHP_SERVER_HOST_KEYS }}" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          echo "‚úÖ Host keys loaded from secret"

      - name: Verify SSH connection
        run: |
          echo "Verifying SSH connection to ${{ matrix.server }}..."
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            -o ConnectTimeout=10 \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
            "echo 'SSH connection successful'"
          if [ $? -ne 0 ]; then
            echo "‚ùå SSH connection verification failed"
            exit 1
          fi

      - name: Download built binary
        if: github.event.inputs.deploy_binaries == 'yes' && github.event.inputs.rebuild == 'yes'
        uses: actions/download-artifact@v6
        with:
          name: nhp-serverd-linux-amd64
          path: ./binaries

      - name: Deploy binary to ${{ matrix.server }}
        if: github.event.inputs.deploy_binaries == 'yes'
        run: |
          if [ "${{ github.event.inputs.rebuild }}" == "yes" ]; then
            echo "üì¶ Deploying newly built binary and plugins to ${{ matrix.server }}..."
            BINARY_PATH="./binaries/endpoints/nhp-serverd"
          else
            echo "‚ö†Ô∏è  Binary deployment requested but rebuild=no"
            echo "Skipping binary deployment (no binary to deploy)"
            exit 0
          fi

          if [ ! -f "$BINARY_PATH" ]; then
            echo "‚ùå Binary file not found at $BINARY_PATH"
            echo "Available files in binaries:"
            find ./binaries -type f 2>/dev/null || echo "binaries directory not found"
            exit 1
          fi

          # Ensure deployment directory exists
          echo "Ensuring deployment directory exists..."
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
            "mkdir -p ${{ env.DEPLOY_PATH }}"

          # Stop the service first
          echo "Stopping nhp-serverd service..."
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
            "sudo systemctl stop nhp-serverd || true"

          # Backup existing binary
          echo "Backing up existing binary..."
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
            "if [ -f ${{ env.DEPLOY_PATH }}/nhp-serverd ]; then cp ${{ env.DEPLOY_PATH }}/nhp-serverd ${{ env.DEPLOY_PATH }}/nhp-serverd.backup.\$(date +%Y%m%d_%H%M%S); fi"

          # Deploy new binary
          echo "Deploying new binary..."
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            "$BINARY_PATH" \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }}:${{ env.DEPLOY_PATH }}/nhp-serverd

          # Set executable permissions
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
            "chmod +x ${{ env.DEPLOY_PATH }}/nhp-serverd"

          # Deploy plugins (.so files only, not config files)
          echo "üîå Deploying plugins..."
          if [ -d ./binaries/build/plugins ]; then
            # Create plugins directory structure on server
            ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=yes \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -o BatchMode=yes \
              ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
              "mkdir -p ${{ env.DEPLOY_PATH }}/plugins/example ${{ env.DEPLOY_PATH }}/plugins/qrauth"

            # Deploy example plugin
            if [ -f ./binaries/build/plugins/example.so ]; then
              echo "Deploying example.so..."
              scp -i ~/.ssh/deploy_key \
                -o StrictHostKeyChecking=yes \
                -o UserKnownHostsFile=~/.ssh/known_hosts \
                -o BatchMode=yes \
                ./binaries/build/plugins/example.so \
                ${{ env.DEPLOY_USER }}@${{ matrix.server }}:${{ env.DEPLOY_PATH }}/plugins/example/example.so
              echo "‚úÖ example.so deployed"
            fi

            # Deploy qrauth plugin
            if [ -f ./binaries/build/plugins/qrauth.so ]; then
              echo "Deploying qrauth.so..."
              scp -i ~/.ssh/deploy_key \
                -o StrictHostKeyChecking=yes \
                -o UserKnownHostsFile=~/.ssh/known_hosts \
                -o BatchMode=yes \
                ./binaries/build/plugins/qrauth.so \
                ${{ env.DEPLOY_USER }}@${{ matrix.server }}:${{ env.DEPLOY_PATH }}/plugins/qrauth/qrauth.so
              echo "‚úÖ qrauth.so deployed"
            fi

            echo "‚úÖ All plugins deployed"
          else
            echo "‚ö†Ô∏è  No plugins found in build artifacts"
          fi

          # Start the service
          echo "Starting nhp-server service..."
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
            "sudo systemctl start nhp-server"

          echo "‚úÖ Binary and plugins deployed successfully to ${{ matrix.server }}"

      - name: Deploy templates to ${{ matrix.server }}
        run: |
          echo "Deploying templates to ${{ matrix.server }}..."

          # Sync templates directory with proper SSH options
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts -o BatchMode=yes" \
            ${{ env.TEMPLATES_SOURCE }}/ \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }}:${{ env.DEPLOY_PATH }}/templates/

          if [ $? -eq 0 ]; then
            echo "‚úÖ Templates deployed successfully to ${{ matrix.server }}"
          else
            echo "‚ùå Deployment failed"
            exit 1
          fi

      - name: Verify deployment
        run: |
          echo "Verifying deployment on ${{ matrix.server }}..."
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
            "ls -la ${{ env.DEPLOY_PATH }}/"
          
          if [ $? -ne 0 ]; then
            echo "‚ùå Deployment verification failed"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key ~/.ssh/known_hosts ~/.ssh/known_hosts.tmp
          rmdir ~/.ssh 2>/dev/null || true

  summary:
    needs: deploy-to-servers
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "## üöÄ Deployment Summary"
          echo ""
          echo "| Item | Value |"
          echo "|------|-------|"
          echo "| **Rebuild** | ${{ github.event.inputs.rebuild }} |"
          echo "| **Deploy Binaries** | ${{ github.event.inputs.deploy_binaries }} |"
          echo "| **Commit** | ${{ github.sha }} |"
          echo "| **Branch** | ${{ github.ref_name }} |"
          echo "| **Triggered by** | ${{ github.actor }} |"
          echo "| **Time** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |"

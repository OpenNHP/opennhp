# Deploy to Demo servers
# This workflow builds and deploys binaries, plugins, and templates to demo NHP servers

name: Deploy Demo

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      confirm:
        description: 'Type "deploy" to confirm deployment'
        required: true
        default: ''
      deploy_binaries:
        description: 'Deploy binaries (nhp-serverd and plugins)'
        required: true
        type: choice
        options:
          - 'no'
          - 'yes'
        default: 'no'

env:
  DEPLOY_USER: ec2-user
  DEPLOY_PATH: /home/ec2-user/nhp-server
  TEMPLATES_SOURCE: docker/nhp-server/templates
  GO_VERSION: '1.25'
  GOMODULE: github.com/OpenNHP/opennhp/nhp

jobs:
  build-binaries:
    if: github.event.inputs.confirm == 'deploy'
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get version info
        id: version
        run: |
          VERSION=$(cat nhp/version/VERSION)
          TIMESTAMP=$(date +%y%m%d%H%M%S)
          FULL_VERSION="${VERSION}.${TIMESTAMP}"
          COMMIT_ID=$(git show -s --format=%H)
          COMMIT_TIME=$(git show -s --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          BUILD_TIME=$(date "+%Y-%m-%d %H:%M:%S")

          echo "version=${FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "commit_id=${COMMIT_ID}" >> $GITHUB_OUTPUT
          echo "commit_time=${COMMIT_TIME}" >> $GITHUB_OUTPUT
          echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT

      - name: Set LD_FLAGS
        id: ldflags
        run: |
          LD_FLAGS="-s -w -X '${GOMODULE}/version.Version=${{ steps.version.outputs.version }}' -X '${GOMODULE}/version.CommitId=${{ steps.version.outputs.commit_id }}' -X '${GOMODULE}/version.CommitTime=${{ steps.version.outputs.commit_time }}' -X '${GOMODULE}/version.BuildTime=${{ steps.version.outputs.build_time }}'"
          echo "ldflags=${LD_FLAGS}" >> $GITHUB_OUTPUT

      - name: Clone external plugin repositories
        if: vars.EXTERNAL_PLUGIN_REPOS != ''
        env:
          REPOS_JSON: ${{ vars.EXTERNAL_PLUGIN_REPOS }}
          PLUGIN_TOKEN: ${{ secrets.PLUGIN_REPO_TOKEN }}
        run: |
          if [ -z "$REPOS_JSON" ]; then
            echo "‚ÑπÔ∏è  No external plugin repositories configured"
            exit 0
          fi

          echo "üì¶ Cloning external plugin repositories..."
          mkdir -p endpoints/examples/server_plugin

          # Use Python for secure JSON parsing and validation
          python3 << 'EOF'
          import json
          import os
          import sys
          import subprocess
          import re

          repos_json = os.environ.get('REPOS_JSON', '[]')
          token = os.environ.get('PLUGIN_TOKEN', '')

          # Strict GitHub URL pattern (security: only allow GitHub HTTPS URLs)
          GITHUB_URL_PATTERN = re.compile(r'^https://github\.com/[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+(?:\.git)?$')

          # Strict path pattern (security: prevent path traversal)
          SAFE_PATH_PATTERN = re.compile(r'^[a-zA-Z0-9_.-]+(/[a-zA-Z0-9_.-]+)*$')

          # Strict ref pattern (security: only allow safe branch/tag names)
          SAFE_REF_PATTERN = re.compile(r'^[a-zA-Z0-9_.-]+$')

          def clone_with_token(url, path, ref, token_value):
              """Clone repository using token embedded in URL.

              This uses GitHub's recommended approach of embedding the token
              in the URL as: https://x-access-token:TOKEN@github.com/...
              The token is only in memory and not exposed in command line args.
              """
              # Embed token in URL for authentication
              if 'github.com' in url:
                  auth_url = url.replace('https://github.com', f'https://x-access-token:{token_value}@github.com')
              else:
                  # For other git hosts, try generic embedding
                  auth_url = url.replace('https://', f'https://x-access-token:{token_value}@')

              result = subprocess.run(
                  ['git', 'clone', '--depth', '1', '--branch', ref, auth_url, path],
                  capture_output=True, text=True
              )
              return result

          try:
              repos = json.loads(repos_json)
          except json.JSONDecodeError as e:
              print(f"‚ùå Invalid JSON: {e}")
              sys.exit(1)

          for repo in repos:
              url = repo.get('url', '')
              path = repo.get('path', '')
              ref = repo.get('ref', 'main')
              subdir = repo.get('subdir', '')  # Optional: subdirectory within the repo

              if not url or not path:
                  continue

              # Security: Validate URL is a GitHub HTTPS URL
              if not GITHUB_URL_PATTERN.match(url):
                  print(f"‚ùå Invalid URL (only GitHub HTTPS URLs allowed): {url}")
                  sys.exit(1)

              # Security: Validate path has no traversal or absolute paths
              if path.startswith('/') or '..' in path or not SAFE_PATH_PATTERN.match(path):
                  print(f"‚ùå Invalid path (no absolute paths or traversal allowed): {path}")
                  sys.exit(1)

              # Security: Validate ref name
              if not SAFE_REF_PATTERN.match(ref):
                  print(f"‚ùå Invalid ref (only alphanumeric, dash, underscore, dot allowed): {ref}")
                  sys.exit(1)

              # Security: Validate subdir if provided
              if subdir and (subdir.startswith('/') or '..' in subdir or not SAFE_PATH_PATTERN.match(subdir)):
                  print(f"‚ùå Invalid subdir (no absolute paths or traversal allowed): {subdir}")
                  sys.exit(1)

              print(f"üì• Cloning {url} (ref: {ref}) to {path}" + (f" (subdir: {subdir})" if subdir else ""))

              # Clone with or without authentication
              if token:
                  result = clone_with_token(url, path, ref, token)
              else:
                  result = subprocess.run(
                      ['git', 'clone', '--depth', '1', '--branch', ref, url, path],
                      capture_output=True, text=True
                  )

              if result.returncode != 0:
                  # Sanitize error message to avoid token leakage
                  error_msg = result.stderr.replace(token, '***') if token else result.stderr
                  print(f"‚ùå Failed: {error_msg}")
                  sys.exit(1)

              print(f"‚úÖ Successfully cloned to {path}")

              # If subdir is specified, move the subdirectory content to the target path
              # This handles repos where the plugin is in a subdirectory
              if subdir:
                  import shutil
                  subdir_path = os.path.join(path, subdir)
                  if os.path.exists(subdir_path):
                      # Create temp directory, move subdir content there, remove original, rename temp
                      temp_path = path + '_temp'
                      shutil.move(subdir_path, temp_path)
                      shutil.rmtree(path)
                      shutil.move(temp_path, path)
                      print(f"üìÅ Moved subdir '{subdir}' to {path}")
                  else:
                      print(f"‚ö†Ô∏è  Subdir '{subdir}' not found in {path}, using repo root")

              # Fix go.mod replace directive for external plugins
              # External plugins may use relative paths like ../nhp/nhp which need adjustment
              go_mod_path = os.path.join(path, 'go.mod')
              if os.path.exists(go_mod_path):
                  with open(go_mod_path, 'r') as f:
                      content = f.read()

                  # Calculate correct relative path from plugin dir to nhp module
                  # Plugin is at: examples/server_plugin/<name>/
                  # NHP module is at: nhp/
                  # So relative path should be: ../../../nhp
                  depth = path.count('/') + 1
                  correct_nhp_path = '../' * depth + 'nhp'

                  # Replace common incorrect patterns
                  original_content = content
                  content = content.replace('replace github.com/OpenNHP/opennhp/nhp => ../nhp/nhp', f'replace github.com/OpenNHP/opennhp/nhp => {correct_nhp_path}')
                  content = content.replace('replace github.com/OpenNHP/opennhp/nhp => ../nhp', f'replace github.com/OpenNHP/opennhp/nhp => {correct_nhp_path}')
                  content = content.replace('replace github.com/OpenNHP/opennhp/nhp => ../../nhp', f'replace github.com/OpenNHP/opennhp/nhp => {correct_nhp_path}')

                  if content != original_content:
                      with open(go_mod_path, 'w') as f:
                          f.write(content)
                      print(f"üìù Fixed go.mod replace directive in {path}")
          EOF

      - name: Build using make
        shell: bash
        env:
          CUSTOM_LD_FLAGS: ${{ steps.ldflags.outputs.ldflags }}
        run: |
          echo "üî® Building nhp-serverd, nhp-acd and plugins..."

          # Initialize and build
          make init
          make serverd acd plugins

          echo "‚úÖ Build completed successfully"

      - name: Prepare deployment artifacts
        run: |
          echo "üì¶ Preparing deployment artifacts..."
          mkdir -p deploy

          # Copy nhp-serverd binary
          if [ -f release/nhp-server/nhp-serverd ]; then
            cp release/nhp-server/nhp-serverd deploy/
            chmod +x deploy/nhp-serverd
            echo "‚úÖ nhp-serverd copied"
          else
            echo "‚ùå nhp-serverd not found"
            exit 1
          fi

          # Copy plugin .so files (not config files)
          mkdir -p deploy/plugins
          if [ -f release/nhp-server/plugins/example/example.so ]; then
            mkdir -p deploy/plugins/example
            cp release/nhp-server/plugins/example/example.so deploy/plugins/example/
            echo "‚úÖ example.so copied"
          fi

          if [ -f release/nhp-server/plugins/authenticator/authenticator.so ]; then
            mkdir -p deploy/plugins/authenticator
            cp release/nhp-server/plugins/authenticator/authenticator.so deploy/plugins/authenticator/
            echo "‚úÖ authenticator.so copied"
          fi

          # Copy templates (built by make plugins)
          if [ -d release/nhp-server/templates ]; then
            cp -r release/nhp-server/templates deploy/
            echo "‚úÖ Templates copied (from Makefile build)"
            ls -la deploy/templates/
          else
            echo "‚ö†Ô∏è  No templates found in release/nhp-server/templates"
          fi

          # Copy nhp-acd binary
          if [ -f release/nhp-ac/nhp-acd ]; then
            cp release/nhp-ac/nhp-acd deploy/
            chmod +x deploy/nhp-acd
            echo "‚úÖ nhp-acd copied"
          else
            echo "‚ö†Ô∏è  nhp-acd not found"
          fi

          ls -la deploy/
          ls -la deploy/plugins/ 2>/dev/null || true

      - name: Upload binary artifact
        uses: actions/upload-artifact@v6
        with:
          name: nhp-serverd-linux-amd64
          path: deploy/
          retention-days: 1

  deploy-to-servers:
    needs: [build-binaries]
    if: github.event.inputs.confirm == 'deploy' && needs.build-binaries.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        server: ${{ fromJson(vars.DEMO_NHP_SERVERS).nhpservers }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Validate server hostname
        run: |
          SERVER="${{ matrix.server }}"

          # RFC 1123 hostname validation: alphanumeric, hyphens, dots
          # Max 253 chars total, max 63 chars per label
          if ! echo "$SERVER" | grep -qE '^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$'; then
            echo "‚ùå SECURITY ERROR: Invalid hostname format: $SERVER"
            echo "Hostnames must comply with RFC 1123"
            exit 1
          fi

          # Block shell metacharacters
          if echo "$SERVER" | grep -qE '[$`();&|<>{}\\]'; then
            echo "‚ùå SECURITY ERROR: Hostname contains shell metacharacters: $SERVER"
            exit 1
          fi

          # Length validation
          if [ ${#SERVER} -gt 253 ]; then
            echo "‚ùå SECURITY ERROR: Hostname exceeds 253 characters"
            exit 1
          fi

          echo "‚úÖ Hostname validation passed: $SERVER"

      - name: Setup SSH key and known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Write SSH private key
          echo "${{ secrets.DEMO_NHP_SERVER_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Setup known_hosts - MUST be pre-configured to prevent MITM attacks
          if [ -z "${{ secrets.DEMO_NHP_SERVER_HOST_KEYS }}" ]; then
            echo "‚ùå SECURITY ERROR: DEMO_NHP_SERVER_HOST_KEYS secret is not configured"
            echo "Host keys must be pre-configured to prevent MITM attacks"
            echo "Please configure the secret with known_hosts entries for all demo servers"
            exit 1
          fi

          echo "${{ secrets.DEMO_NHP_SERVER_HOST_KEYS }}" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          echo "‚úÖ Host keys loaded from secret"

      - name: Verify SSH connection
        run: |
          echo "Verifying SSH connection to ${{ matrix.server }}..."
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            -o ConnectTimeout=10 \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
            "echo 'SSH connection successful'"
          if [ $? -ne 0 ]; then
            echo "‚ùå SSH connection verification failed"
            exit 1
          fi

      - name: Download built binary
        uses: actions/download-artifact@v6
        with:
          name: nhp-serverd-linux-amd64
          path: ./binaries

      - name: Deploy binary to ${{ matrix.server }}
        if: github.event.inputs.deploy_binaries == 'yes'
        run: |
          echo "üì¶ Deploying newly built binary and plugins to ${{ matrix.server }}..."
          BINARY_PATH="./binaries/nhp-serverd"

          if [ ! -f "$BINARY_PATH" ]; then
            echo "‚ùå Binary file not found at $BINARY_PATH"
            echo "Available files in binaries:"
            find ./binaries -type f 2>/dev/null || echo "binaries directory not found"
            exit 1
          fi

          # Ensure deployment directory exists
          echo "Ensuring deployment directory exists..."
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
            "mkdir -p ${{ env.DEPLOY_PATH }}"

          # Stop the service first
          echo "Stopping nhp-serverd service..."
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
            "sudo systemctl stop nhp-serverd || true"

          # Deploy new binary
          echo "Deploying new binary..."
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            "$BINARY_PATH" \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }}:${{ env.DEPLOY_PATH }}/nhp-serverd

          # Set executable permissions
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
            "chmod +x ${{ env.DEPLOY_PATH }}/nhp-serverd"

          # Deploy plugins (.so files only, not config files)
          echo "üîå Deploying plugins..."
          if [ -d ./binaries/plugins ]; then
            # Create plugins directory structure on server
            ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=yes \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -o BatchMode=yes \
              ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
              "mkdir -p ${{ env.DEPLOY_PATH }}/plugins/example ${{ env.DEPLOY_PATH }}/plugins/authenticator"

            # Deploy example plugin
            if [ -f ./binaries/plugins/example/example.so ]; then
              echo "Deploying example.so..."
              scp -i ~/.ssh/deploy_key \
                -o StrictHostKeyChecking=yes \
                -o UserKnownHostsFile=~/.ssh/known_hosts \
                -o BatchMode=yes \
                ./binaries/plugins/example/example.so \
                ${{ env.DEPLOY_USER }}@${{ matrix.server }}:${{ env.DEPLOY_PATH }}/plugins/example/example.so
              echo "‚úÖ example.so deployed"
            fi

            # Deploy authenticator plugin
            if [ -f ./binaries/plugins/authenticator/authenticator.so ]; then
              echo "Deploying authenticator.so..."
              scp -i ~/.ssh/deploy_key \
                -o StrictHostKeyChecking=yes \
                -o UserKnownHostsFile=~/.ssh/known_hosts \
                -o BatchMode=yes \
                ./binaries/plugins/authenticator/authenticator.so \
                ${{ env.DEPLOY_USER }}@${{ matrix.server }}:${{ env.DEPLOY_PATH }}/plugins/authenticator/authenticator.so
              echo "‚úÖ authenticator.so deployed"
            fi

            echo "‚úÖ All plugins deployed"
          else
            echo "‚ö†Ô∏è  No plugins found in build artifacts"
          fi

          echo "‚úÖ Binary and plugins deployed successfully to ${{ matrix.server }}"

      - name: Deploy templates to ${{ matrix.server }}
        run: |
          echo "Deploying templates to ${{ matrix.server }}..."

          # Use templates from build artifacts
          if [ -d ./binaries/templates ]; then
            TEMPLATES_SOURCE="./binaries/templates"
            echo "üì¶ Using Makefile-built templates from artifact"
          else
            TEMPLATES_SOURCE="${{ env.TEMPLATES_SOURCE }}"
            echo "üì¶ Using docker templates (fallback)"
          fi

          # Sync templates directory with proper SSH options
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts -o BatchMode=yes" \
            "$TEMPLATES_SOURCE/" \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }}:${{ env.DEPLOY_PATH }}/templates/

          if [ $? -eq 0 ]; then
            echo "‚úÖ Templates deployed successfully to ${{ matrix.server }}"
          else
            echo "‚ùå Deployment failed"
            exit 1
          fi

      - name: Restart nhp-serverd on ${{ matrix.server }}
        run: |
          echo "üîÑ Restarting nhp-serverd service on ${{ matrix.server }}..."

          # Restart the service
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
            "sudo systemctl restart nhp-serverd"

          # Verify service started successfully
          echo "Verifying service status..."
          sleep 2
          SERVICE_STATUS=$(ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
            "sudo systemctl is-active nhp-serverd" || true)

          if [ "$SERVICE_STATUS" = "active" ]; then
            echo "‚úÖ nhp-serverd service is running"
          else
            echo "‚ùå Service failed to start! Status: $SERVICE_STATUS"
            echo "Checking service logs..."
            ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=yes \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -o BatchMode=yes \
              ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
              "sudo journalctl -u nhp-serverd -n 20 --no-pager" || true
            echo "‚ùå Deployment failed: service not running"
            exit 1
          fi

          echo "‚úÖ nhp-serverd restarted successfully on ${{ matrix.server }}"

      - name: Deploy to NHP-AC servers via ${{ matrix.server }}
        if: github.event.inputs.deploy_binaries == 'yes'
        env:
          NHPACS_JSON: ${{ toJson(fromJson(vars.DEMO_NHP_SERVERS).nhpacs) }}
        run: |
          echo "üîÑ Deploying nhp-acd and templates to NHP-AC servers via jump host ${{ matrix.server }}..."

          # Check if nhp-acd binary exists
          if [ ! -f ./binaries/nhp-acd ]; then
            echo "‚ö†Ô∏è  nhp-acd not found in binaries, skipping NHP-AC deployment"
            exit 0
          fi

          # Check if example_acdemo.html exists in templates
          DEPLOY_TEMPLATE=false
          if [ -f ./binaries/templates/example/example_acdemo.html ]; then
            DEPLOY_TEMPLATE=true
          fi

          # Copy files to the jump host
          echo "üì¶ Copying nhp-acd to jump host..."
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            ./binaries/nhp-acd \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }}:/tmp/nhp-acd

          if [ "$DEPLOY_TEMPLATE" = true ]; then
            echo "üì¶ Copying example_acdemo.html to jump host..."
            scp -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=yes \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -o BatchMode=yes \
              ./binaries/templates/example/example_acdemo.html \
              ${{ env.DEPLOY_USER }}@${{ matrix.server }}:/tmp/example_acdemo.html
          fi

          # Parse nhpacs JSON and deploy to each AC server
          echo "$NHPACS_JSON" | python3 -c "
          import json
          import sys

          nhpacs = json.load(sys.stdin)
          for ac in nhpacs:
              ip = ac.get('ip', '')
              username = ac.get('username', 'ec2-user')
              if ip:
                  print(f'{username}@{ip}')
          " | while read AC_TARGET; do
            if [ -n "$AC_TARGET" ]; then
              echo "üì¶ Deploying to NHP-AC: $AC_TARGET"

              # Deploy nhp-acd binary: stop service, copy binary, start service
              ssh -i ~/.ssh/deploy_key \
                -o StrictHostKeyChecking=yes \
                -o UserKnownHostsFile=~/.ssh/known_hosts \
                -o BatchMode=yes \
                ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
                "ssh -o StrictHostKeyChecking=no $AC_TARGET 'sudo systemctl stop nhp-acd || true' && \
                 scp -o StrictHostKeyChecking=no /tmp/nhp-acd $AC_TARGET:/tmp/nhp-acd && \
                 ssh -o StrictHostKeyChecking=no $AC_TARGET 'sudo cp /tmp/nhp-acd /home/ec2-user/nhp-ac/nhp-acd && sudo chmod +x /home/ec2-user/nhp-ac/nhp-acd && rm /tmp/nhp-acd && sudo systemctl start nhp-acd'"

              if [ $? -eq 0 ]; then
                echo "‚úÖ nhp-acd deployed to $AC_TARGET"
              else
                echo "‚ùå Failed to deploy nhp-acd to $AC_TARGET"
                exit 1
              fi

              # Deploy template if exists
              if [ "$DEPLOY_TEMPLATE" = true ]; then
                ssh -i ~/.ssh/deploy_key \
                  -o StrictHostKeyChecking=yes \
                  -o UserKnownHostsFile=~/.ssh/known_hosts \
                  -o BatchMode=yes \
                  ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
                  "scp -o StrictHostKeyChecking=no /tmp/example_acdemo.html $AC_TARGET:/tmp/example_acdemo.html && \
                   ssh -o StrictHostKeyChecking=no $AC_TARGET 'sudo cp /tmp/example_acdemo.html /etc/nginx/html/index_apidemo_opennhp_org.html && sudo chmod 644 /etc/nginx/html/index_apidemo_opennhp_org.html && rm /tmp/example_acdemo.html'"

                if [ $? -eq 0 ]; then
                  echo "‚úÖ Template deployed to $AC_TARGET"
                else
                  echo "‚ùå Failed to deploy template to $AC_TARGET"
                  exit 1
                fi
              fi
            fi
          done

          # Clean up temp files on jump host
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
            "rm -f /tmp/nhp-acd /tmp/example_acdemo.html"

          echo "‚úÖ All NHP-AC servers updated successfully"

      - name: Deploy templates to NHP-AC servers via ${{ matrix.server }}
        if: github.event.inputs.deploy_binaries == 'no'
        env:
          NHPACS_JSON: ${{ toJson(fromJson(vars.DEMO_NHP_SERVERS).nhpacs) }}
        run: |
          echo "üîÑ Deploying templates to NHP-AC servers via jump host ${{ matrix.server }}..."

          # Check if example_acdemo.html exists in templates
          if [ ! -f ./binaries/templates/example/example_acdemo.html ]; then
            echo "‚ö†Ô∏è  example/example_acdemo.html not found in templates, skipping NHP-AC template deployment"
            exit 0
          fi

          # Copy template file to the jump host
          echo "üì¶ Copying example_acdemo.html to jump host..."
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            ./binaries/templates/example/example_acdemo.html \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }}:/tmp/example_acdemo.html

          # Parse nhpacs JSON and deploy to each AC server
          echo "$NHPACS_JSON" | python3 -c "
          import json
          import sys

          nhpacs = json.load(sys.stdin)
          for ac in nhpacs:
              ip = ac.get('ip', '')
              username = ac.get('username', 'ec2-user')
              if ip:
                  print(f'{username}@{ip}')
          " | while read AC_TARGET; do
            if [ -n "$AC_TARGET" ]; then
              echo "üì¶ Deploying template to NHP-AC: $AC_TARGET"

              ssh -i ~/.ssh/deploy_key \
                -o StrictHostKeyChecking=yes \
                -o UserKnownHostsFile=~/.ssh/known_hosts \
                -o BatchMode=yes \
                ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
                "scp -o StrictHostKeyChecking=no /tmp/example_acdemo.html $AC_TARGET:/tmp/example_acdemo.html && \
                 ssh -o StrictHostKeyChecking=no $AC_TARGET 'sudo cp /tmp/example_acdemo.html /etc/nginx/html/index_apidemo_opennhp_org.html && sudo chmod 644 /etc/nginx/html/index_apidemo_opennhp_org.html && rm /tmp/example_acdemo.html'"

              if [ $? -eq 0 ]; then
                echo "‚úÖ Template deployed to $AC_TARGET"
              else
                echo "‚ùå Failed to deploy template to $AC_TARGET"
                exit 1
              fi
            fi
          done

          # Clean up temp file on jump host
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
            "rm -f /tmp/example_acdemo.html"

          echo "‚úÖ All NHP-AC servers templates updated successfully"

      - name: Verify deployment
        run: |
          echo "Verifying deployment on ${{ matrix.server }}..."
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
            "ls -la ${{ env.DEPLOY_PATH }}/"
          
          if [ $? -ne 0 ]; then
            echo "‚ùå Deployment verification failed"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key ~/.ssh/known_hosts ~/.ssh/known_hosts.tmp
          rmdir ~/.ssh 2>/dev/null || true

  summary:
    needs: deploy-to-servers
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "## üöÄ Deployment Summary"
          echo ""
          echo "| Item | Value |"
          echo "|------|-------|"
          echo "| **Deploy Binaries** | ${{ github.event.inputs.deploy_binaries }} |"
          echo "| **Commit** | ${{ github.sha }} |"
          echo "| **Branch** | ${{ github.ref_name }} |"
          echo "| **Triggered by** | ${{ github.actor }} |"
          echo "| **Time** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |"

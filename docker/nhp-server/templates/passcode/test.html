<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <script>
        /**
         * 支持跨域的Token刷新管理器
         */
        class CrossDomainTokenRefresher {
            constructor(options = {}) {
                this.refreshInterval = null;
                this.refreshIntervalTime = options.interval || 100000; // 默认10s
                this.tokenName = options.tokenName || 'nhp_token';
                this.refreshTokenName = options.refreshTokenName || 'nhp_refresh_token';
                this.apiEndpoint = options.apiEndpoint || '/plugins/{{ .aspId }}?resid={{ .resId }}&action=refresh';
                this.withCredentials = options.withCredentials || true;
                this.corsOptions = {
                    mode: 'cors',
                    credentials: this.withCredentials ? 'include' : 'same-origin'
                };
                this.logFunction = options.log || console.log;
            }

            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                const logMessage = `[${timestamp}] ${message}`;
                this.logFunction(logMessage);
            }

            getCookie(name) {
                if (this.withCredentials) {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.startsWith(name + '=')) {
                            return decodeURIComponent(cookie.substring(name.length + 1));
                        }
                    }
                }
                return null;
            }

            async refreshToken() {
                //const refreshToken = this.getCookie(this.refreshTokenName);
                const refreshToken = "test";
                if (!refreshToken) {
                    this.log('刷新失败: 缺少refresh token');
                    this.stop();
                    return;
                }

                try {
                    this.log('正在刷新Token...');
                    const response = await fetch(this.apiEndpoint, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.getCookie(this.tokenName)}`
                        },
                        ...this.corsOptions
                    });

                    if (!response.ok) {
                        throw new Error(`请求失败: ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.errCode == "52005") {
                        this.stop();
                        this.log('Token刷新失败:'+data.errMsg);
                        return;
                    }                   
                } catch (error) {
                    this.log(`刷新失败: ${error.message}`);
                    this.handleRefreshError(error);
                }
            }

            handleNewTokens(accessToken, refreshToken) {
                const setCookie = (name, value) => {
                    document.cookie = `${name}=${encodeURIComponent(value)}; path=/; ${
                        location.protocol === 'https:' ? 'secure; ' : ''
                    }samesite=lax`;
                };

                setCookie(this.tokenName, accessToken);
                if (refreshToken) {
                    setCookie(this.refreshTokenName, refreshToken);
                }
            }

            handleRefreshError(error) {
                if (error.message.includes('401')) {
                    this.stop();
                    this.redirectToLogin();
                } else if (error.message.includes('网络')) {
                    setTimeout(() => this.refreshToken(), 30000);
                }
            }

            redirectToLogin() {
                this.log('Token无效，跳转到登录页');
                window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
            }

            start() {
                this.refreshToken();
                this.refreshInterval = setInterval(
                    () => this.refreshToken(),
                    this.refreshIntervalTime
                );
                this.log(`Token刷新已启动，间隔: ${this.refreshIntervalTime/1000}秒`);
            }

            stop() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                    this.refreshInterval = null;
                }
                this.log('Token刷新已停止');
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化刷新器
            const refresher = new CrossDomainTokenRefresher({
                apiEndpoint: '',
                withCredentials: true,
                interval: 10000, // 10秒用于演示
            });

            refresher.start();
        });
    </script>
</body>
</html>
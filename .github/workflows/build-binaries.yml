# This workflow builds binaries for all modules and uploads them as artifacts

name: Build Binaries

on:
  push:
    branches: ["main", "develop"]
    tags:
      - 'v*'
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      build_components:
        description: 'Components to build (comma-separated: agentd,acd,serverd,db,kgc,plugins,all)'
        required: false
        default: 'serverd,plugins'
        type: string

# Restrict default permissions for security (CodeQL alert fix)
permissions:
  contents: read

env:
  GO_VERSION: '1.25'
  GOMODULE: github.com/OpenNHP/opennhp/nhp
  # Use workflow input if provided, otherwise build serverd and plugins by default
  BUILD_COMPONENTS: ${{ github.event.inputs.build_components || 'serverd,plugins' }}

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            ext: ""
            archive_ext: tar.gz
          - os: windows-latest
            goos: windows
            goarch: amd64
            ext: ".exe"
            archive_ext: zip
          - os: macos-latest
            goos: darwin
            goarch: amd64
            ext: ""
            archive_ext: tar.gz

    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Get full history for commit info

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get version info
        id: version
        shell: bash
        run: |
          VERSION=$(cat nhp/version/VERSION)
          TIMESTAMP=$(date +%y%m%d%H%M%S)
          FULL_VERSION="${VERSION}.${TIMESTAMP}"
          COMMIT_ID=$(git show -s --format=%H)
          COMMIT_TIME=$(git show -s --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          BUILD_TIME=$(date "+%Y-%m-%d %H:%M:%S")
          
          echo "version=${FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "commit_id=${COMMIT_ID}" >> $GITHUB_OUTPUT
          echo "commit_time=${COMMIT_TIME}" >> $GITHUB_OUTPUT
          echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT
          
          echo "Version: ${FULL_VERSION}"
          echo "Commit ID: ${COMMIT_ID}"
          echo "Commit Time: ${COMMIT_TIME}"
          echo "Build Time: ${BUILD_TIME}"

      - name: Set LD_FLAGS
        id: ldflags
        shell: bash
        run: |
          LD_FLAGS="-s -w -X '${GOMODULE}/version.Version=${{ steps.version.outputs.version }}' -X '${GOMODULE}/version.CommitId=${{ steps.version.outputs.commit_id }}' -X '${GOMODULE}/version.CommitTime=${{ steps.version.outputs.commit_time }}' -X '${GOMODULE}/version.BuildTime=${{ steps.version.outputs.build_time }}'"
          echo "ldflags=${LD_FLAGS}" >> $GITHUB_OUTPUT

      - name: Clone external plugin repositories
        if: vars.EXTERNAL_PLUGIN_REPOS != ''
        shell: bash
        env:
          REPOS_JSON: ${{ vars.EXTERNAL_PLUGIN_REPOS }}
          PLUGIN_TOKEN: ${{ secrets.PLUGIN_REPO_TOKEN }}
        run: |
          # Parse JSON configuration for external repositories
          # Expected format: [{"url": "https://github.com/org/repo", "path": "endpoints/examples/server_plugin/plugin-name", "ref": "main"}]

          if [ -z "$REPOS_JSON" ]; then
            echo "‚ÑπÔ∏è  No external plugin repositories configured"
            exit 0
          fi

          echo "üì¶ Cloning external plugin repositories..."
          mkdir -p endpoints/examples/server_plugin

          # Use Python for secure JSON parsing and validation
          python3 << 'EOF'
          import json
          import os
          import sys
          import subprocess
          import re

          repos_json = os.environ.get('REPOS_JSON', '[]')
          token = os.environ.get('PLUGIN_TOKEN', '')

          # Strict GitHub URL pattern (security: only allow GitHub HTTPS URLs)
          GITHUB_URL_PATTERN = re.compile(r'^https://github\.com/[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+(?:\.git)?$')

          # Strict path pattern (security: prevent path traversal)
          SAFE_PATH_PATTERN = re.compile(r'^[a-zA-Z0-9_.-]+(/[a-zA-Z0-9_.-]+)*$')

          # Strict ref pattern (security: only allow safe branch/tag names)
          SAFE_REF_PATTERN = re.compile(r'^[a-zA-Z0-9_.-]+$')

          def clone_with_token(url, path, ref, token_value):
              """Clone repository using GIT_ASKPASS to pass credentials securely.

              This approach avoids writing tokens to disk or exposing them in
              command line arguments. The token is passed via environment variable
              to a simple askpass script that outputs it to stdout.
              """
              env = os.environ.copy()
              # GIT_ASKPASS script that reads password from environment
              # This avoids writing the token to any file
              env['GIT_ASKPASS_TOKEN'] = token_value
              env['GIT_ASKPASS'] = '/bin/sh'
              env['GIT_USERNAME'] = 'x-access-token'

              # Create inline askpass via shell -c
              # Git will call: /bin/sh -c 'echo "$GIT_ASKPASS_TOKEN"'
              result = subprocess.run(
                  ['git', 'clone', '--depth', '1', '--branch', ref,
                   '-c', 'credential.helper=',
                   '-c', 'core.askPass=/bin/sh -c "echo $GIT_ASKPASS_TOKEN"',
                   url, path],
                  capture_output=True, text=True, env=env
              )
              return result

          try:
              repos = json.loads(repos_json)
          except json.JSONDecodeError as e:
              print(f"‚ùå Invalid JSON: {e}")
              sys.exit(1)

          for repo in repos:
              url = repo.get('url', '')
              path = repo.get('path', '')
              ref = repo.get('ref', 'main')

              if not url or not path:
                  continue

              # Security: Validate URL is a GitHub HTTPS URL
              if not GITHUB_URL_PATTERN.match(url):
                  print(f"‚ùå Invalid URL (only GitHub HTTPS URLs allowed): {url}")
                  sys.exit(1)

              # Security: Validate path has no traversal or absolute paths
              if path.startswith('/') or '..' in path or not SAFE_PATH_PATTERN.match(path):
                  print(f"‚ùå Invalid path (no absolute paths or traversal allowed): {path}")
                  sys.exit(1)

              # Security: Validate ref name
              if not SAFE_REF_PATTERN.match(ref):
                  print(f"‚ùå Invalid ref (only alphanumeric, dash, underscore, dot allowed): {ref}")
                  sys.exit(1)

              print(f"üì• Cloning {url} (ref: {ref}) to {path}")

              # Clone with or without authentication
              if token:
                  result = clone_with_token(url, path, ref, token)
              else:
                  result = subprocess.run(
                      ['git', 'clone', '--depth', '1', '--branch', ref, url, path],
                      capture_output=True, text=True
                  )

              if result.returncode != 0:
                  # Sanitize error message to avoid token leakage
                  error_msg = result.stderr.replace(token, '***') if token else result.stderr
                  print(f"‚ùå Failed: {error_msg}")
                  sys.exit(1)

              print(f"‚úÖ Successfully cloned to {path}")
          EOF

          echo "‚úÖ All external plugin repositories cloned successfully"

      - name: Build components using make
        shell: bash
        env:
          CUSTOM_LD_FLAGS: ${{ steps.ldflags.outputs.ldflags }}
        run: |
          echo "üî® Building components: $BUILD_COMPONENTS"

          # Define valid components (whitelist)
          VALID_COMPONENTS="agentd acd serverd db kgc plugins all"

          # Initialize build environment
          make init

          # Parse and build each component
          IFS=',' read -ra COMPONENTS <<< "$BUILD_COMPONENTS"
          for component in "${COMPONENTS[@]}"; do
            component=$(echo "$component" | tr -d ' ')  # Trim whitespace

            # Validate component name against whitelist (security: prevent command injection)
            if ! echo "$VALID_COMPONENTS" | grep -qw "$component"; then
              echo "‚ùå Invalid component name: $component"
              echo "   Valid components: $VALID_COMPONENTS"
              exit 1
            fi

            case "$component" in
              agentd|acd|serverd|db|kgc)
                echo "Building $component..."
                make "$component"
                ;;
              plugins)
                # Go plugins are not supported on Windows
                if [ "${{ matrix.goos }}" != "windows" ]; then
                  echo "Building $component..."
                  make "$component"
                else
                  echo "‚ö†Ô∏è  Skipping plugins build on Windows (not supported by Go)"
                fi
                ;;
              all)
                echo "Building all components..."
                if [ "${{ matrix.goos }}" != "windows" ]; then
                  make agentd acd serverd db kgc plugins
                else
                  echo "‚ö†Ô∏è  Building without plugins on Windows (not supported by Go)"
                  make agentd acd serverd db kgc
                fi
                break
                ;;
            esac
          done

          echo "‚úÖ Build completed successfully"

      - name: Prepare output directory
        shell: bash
        run: |
          echo "üì¶ Preparing output directory..."
          mkdir -p output

          # Copy built components from release/ to output/
          if [ -d release/nhp-agent ]; then
            cp -r release/nhp-agent output/
            echo "‚úÖ nhp-agent copied to output"
          fi

          if [ -d release/nhp-ac ]; then
            cp -r release/nhp-ac output/
            echo "‚úÖ nhp-ac copied to output"
          fi

          if [ -d release/nhp-server ]; then
            cp -r release/nhp-server output/
            echo "‚úÖ nhp-server copied to output (includes Makefile-built plugin templates)"
          fi

          if [ -d release/nhp-db ]; then
            cp -r release/nhp-db output/
            echo "‚úÖ nhp-db copied to output"
          fi

          if [ -d release/nhp-kgc ]; then
            cp -r release/nhp-kgc output/
            echo "‚úÖ nhp-kgc copied to output"
          fi

          echo "‚úÖ Output directory prepared"
          ls -la output/

      # Upload each module as independent artifact (only if built)
      - name: Upload nhp-agent artifact
        if: contains(env.BUILD_COMPONENTS, 'agentd') || contains(env.BUILD_COMPONENTS, 'all')
        uses: actions/upload-artifact@v6
        with:
          name: nhp-agent-${{ matrix.goos }}-${{ matrix.goarch }}
          path: output/nhp-agent/
          retention-days: 30

      - name: Upload nhp-ac artifact
        if: contains(env.BUILD_COMPONENTS, 'acd') || contains(env.BUILD_COMPONENTS, 'all')
        uses: actions/upload-artifact@v6
        with:
          name: nhp-ac-${{ matrix.goos }}-${{ matrix.goarch }}
          path: output/nhp-ac/
          retention-days: 30

      - name: Upload nhp-server artifact
        if: contains(env.BUILD_COMPONENTS, 'serverd') || contains(env.BUILD_COMPONENTS, 'all')
        uses: actions/upload-artifact@v6
        with:
          name: nhp-server-${{ matrix.goos }}-${{ matrix.goarch }}
          path: output/nhp-server/
          retention-days: 30

      - name: Upload nhp-db artifact
        if: contains(env.BUILD_COMPONENTS, 'db') || contains(env.BUILD_COMPONENTS, 'all')
        uses: actions/upload-artifact@v6
        with:
          name: nhp-db-${{ matrix.goos }}-${{ matrix.goarch }}
          path: output/nhp-db/
          retention-days: 30

      - name: Upload nhp-kgc artifact
        if: contains(env.BUILD_COMPONENTS, 'kgc') || contains(env.BUILD_COMPONENTS, 'all')
        uses: actions/upload-artifact@v6
        with:
          name: nhp-kgc-${{ matrix.goos }}-${{ matrix.goarch }}
          path: output/nhp-kgc/
          retention-days: 30

      # Create complete package artifact (only when building all components)
      - name: Create archive (Unix)
        if: matrix.os != 'windows-latest' && contains(env.BUILD_COMPONENTS, 'all')
        shell: bash
        run: |
          cd output
          # Verify all required directories exist before archiving
          MISSING=""
          for dir in nhp-agent nhp-ac nhp-db nhp-server nhp-kgc; do
            if [ ! -d "$dir" ]; then
              MISSING="$MISSING $dir"
            fi
          done
          if [ -n "$MISSING" ]; then
            echo "‚ùå Missing directories:$MISSING"
            echo "Archive creation skipped due to partial build"
            exit 0
          fi
          tar -czvf opennhp-${{ steps.version.outputs.version }}-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz nhp-agent nhp-ac nhp-db nhp-server nhp-kgc

      - name: Create archive (Windows)
        if: matrix.os == 'windows-latest' && contains(env.BUILD_COMPONENTS, 'all')
        shell: pwsh
        run: |
          cd output
          # Verify all required directories exist before archiving
          $dirs = @("nhp-agent", "nhp-ac", "nhp-db", "nhp-server", "nhp-kgc")
          $missing = @()
          foreach ($dir in $dirs) {
            if (-not (Test-Path $dir)) {
              $missing += $dir
            }
          }
          if ($missing.Count -gt 0) {
            Write-Host "‚ùå Missing directories: $($missing -join ', ')"
            Write-Host "Archive creation skipped due to partial build"
            exit 0
          }
          Compress-Archive -Path nhp-agent, nhp-ac, nhp-db, nhp-server, nhp-kgc -DestinationPath "opennhp-${{ steps.version.outputs.version }}-${{ matrix.goos }}-${{ matrix.goarch }}.zip"

      - name: Upload full package artifact
        if: contains(env.BUILD_COMPONENTS, 'all')
        uses: actions/upload-artifact@v6
        with:
          name: opennhp-${{ matrix.goos }}-${{ matrix.goarch }}
          path: output/opennhp-${{ steps.version.outputs.version }}-${{ matrix.goos }}-${{ matrix.goarch }}.${{ matrix.archive_ext }}
          retention-days: 30

  # Aggregate artifacts from all platforms
  summary:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: all-artifacts

      - name: List artifacts
        run: |
          echo "=== All built artifacts ==="
          find all-artifacts -type f -name "*.tar.gz" -o -name "*.zip" -o -name "nhp-*" | head -100
          echo ""
          echo "=== Artifact sizes ==="
          du -sh all-artifacts/*

      - name: Upload combined artifact
        uses: actions/upload-artifact@v6
        with:
          name: opennhp-all-platforms
          path: all-artifacts/opennhp-*/
          retention-days: 30

  # Update latest release (only on main branch, not PRs)
  latest-release:
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all package artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: opennhp-*
          path: release-artifacts
          merge-multiple: false

      - name: Prepare release files
        run: |
          mkdir -p release-files
          find release-artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release-files/ \;
          ls -la release-files/

      - name: Update latest release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Build
          body: |
            **Latest Build Artifacts**

            This release is automatically updated after each build with the latest binaries.

            Build Time: ${{ github.event.head_commit.timestamp }}
            Commit: ${{ github.sha }}
          files: release-files/*
          prerelease: true
          make_latest: false

  # Create official release when a tag is pushed
  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all package artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: opennhp-*
          path: release-artifacts
          merge-multiple: false

      - name: Prepare release files
        run: |
          mkdir -p release-files
          find release-artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release-files/ \;
          ls -la release-files/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-files/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}


# Deploy templates to Demo servers
# This workflow deploys templates to demo NHP servers

name: Deploy Demo

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      confirm:
        description: 'Type "deploy" to confirm deployment'
        required: true
        default: ''

env:
  DEPLOY_USER: ec2-user
  DEPLOY_PATH: /home/ec2-user/nhp-server/templates
  TEMPLATES_SOURCE: docker/nhp-server/templates

jobs:
  deploy-templates:
    if: github.event.inputs.confirm == 'deploy'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        server: ${{ fromJson(vars.DEMO_NHP_SERVERS) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key and known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write SSH private key
          echo "${{ secrets.DEMO_NHP_SERVER_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Setup known_hosts with proper verification
          # Option 1: Use pre-configured host keys from secret (recommended)
          if [ -n "${{ secrets.DEMO_NHP_SERVER_HOST_KEYS }}" ]; then
            echo "${{ secrets.DEMO_NHP_SERVER_HOST_KEYS }}" > ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts
          else
            # Option 2: Scan and verify host keys (fallback)
            # This requires manual verification on first run
            echo "âš ï¸  Warning: Host keys not pre-configured. Scanning host keys..."
            ssh-keyscan -H ${{ matrix.server }} > ~/.ssh/known_hosts.tmp 2>&1
            if [ $? -eq 0 ] && [ -s ~/.ssh/known_hosts.tmp ]; then
              # Verify we got valid host keys
              if grep -q "ssh-" ~/.ssh/known_hosts.tmp; then
                mv ~/.ssh/known_hosts.tmp ~/.ssh/known_hosts
                chmod 644 ~/.ssh/known_hosts
                echo "âœ… Host keys scanned successfully"
              else
                echo "âŒ Failed to get valid host keys"
                exit 1
              fi
            else
              echo "âŒ Failed to scan host keys"
              exit 1
            fi
          fi

      - name: Verify SSH connection
        run: |
          echo "Verifying SSH connection to ${{ matrix.server }}..."
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            -o ConnectTimeout=10 \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
            "echo 'SSH connection successful'"
          if [ $? -ne 0 ]; then
            echo "âŒ SSH connection verification failed"
            exit 1
          fi

      - name: Deploy templates to ${{ matrix.server }}
        run: |
          echo "Deploying templates to ${{ matrix.server }}..."
          
          # Sync templates directory with proper SSH options
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts -o BatchMode=yes" \
            ${{ env.TEMPLATES_SOURCE }}/ \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }}:${{ env.DEPLOY_PATH }}/
          
          if [ $? -eq 0 ]; then
            echo "âœ… Templates deployed successfully to ${{ matrix.server }}"
          else
            echo "âŒ Deployment failed"
            exit 1
          fi

      - name: Verify deployment
        run: |
          echo "Verifying deployment on ${{ matrix.server }}..."
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            ${{ env.DEPLOY_USER }}@${{ matrix.server }} \
            "ls -la ${{ env.DEPLOY_PATH }}/"
          
          if [ $? -ne 0 ]; then
            echo "âŒ Deployment verification failed"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key ~/.ssh/known_hosts ~/.ssh/known_hosts.tmp
          rmdir ~/.ssh 2>/dev/null || true

  summary:
    needs: deploy-templates
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary"
          echo ""
          echo "| Item | Value |"
          echo "|------|-------|"
          echo "| **Commit** | ${{ github.sha }} |"
          echo "| **Branch** | ${{ github.ref_name }} |"
          echo "| **Triggered by** | ${{ github.actor }} |"
          echo "| **Time** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |"
